---
title: "栅格数据"
author: "Jianqi Huang"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 空间对象

```{r}
library(sp)
getClass("Spatial")
```

### CRS(coordinate reference system)
对于PROJ.4-format 字符串描述的坐标最为简便的是"+proj=longlat".

```{r}
getClass("CRS")
```


```{r}
m <- matrix(c(0,0,1,1), nrow = 2, dimnames = list(NULL,c("min","max")))
m
crs <- CRS(projargs = as.character(NA))
crs
```


```{r}
S <- Spatial(bbox = m,proj4string = crs)
S
```



```{r}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
  terra, # handle raster data
  raster, # handle raster data
  exactextractr, # fast extractions
  sf, # vector data operations
  dplyr, # data wrangling
  tidyr, # data wrangling
  data.table, # data wrangling
  prism, # download PRISM data
  tictoc, # timing codes
  tigris, # to get county sf
  tmap # for mapping
)
```

## The element of geometry

### Points

```{r}
getClass("SpatialPoints")
```
对于SpatialPoint 实际上可多于两维的数据格式。



```{r}
#--- create points ---#
point_1 <- st_point(c(2, 2))
point_2 <- st_point(c(1, 1))
point_3 <- st_point(c(1, 3))

#--- combine the points to make a single  sf of points ---#
(
  points <- list(point_1, point_2, point_3) %>% 
    st_sfc() %>% 
    st_as_sf() %>% 
    mutate(point_name = c("point 1", "point 2", "point 3"))
)
```


### Lines

```{r}
#--- create points ---#
line_1 <- st_linestring(rbind(c(0, 0), c(2.5, 0.5)))
line_2 <- st_linestring(rbind(c(1.5, 0.5), c(2.5, 2)))

#--- combine the points to make a single  sf of points ---#
(
lines <- list(line_1, line_2) %>% 
  st_sfc() %>% 
  st_as_sf() %>% 
  mutate(line_name = c("line 1", "line 2"))
)
```

### Polygons

```{r}
#--- create polygons ---#
polygon_1 <- st_polygon(list(
  rbind(c(0, 0), c(2, 0), c(2, 2), c(0, 2), c(0, 0)) 
))

polygon_2 <- st_polygon(list(
  rbind(c(0.5, 1.5), c(0.5, 3.5), c(2.5, 3.5), c(2.5, 1.5), c(0.5, 1.5)) 
))

polygon_3 <- st_polygon(list(
  rbind(c(0.5, 2.5), c(0.5, 3.2), c(2.3, 3.2), c(2, 2), c(0.5, 2.5)) 
))

#--- combine the polygons to make an sf of polygons ---#
(
polygons <- list(polygon_1, polygon_2, polygon_3) %>% 
  st_sfc() %>% 
  st_as_sf() %>% 
  mutate(polygon_name = c("polygon 1", "polygon 2", "polygon 3"))
)
```
```{r}
ggplot() +
  geom_sf(data = polygons, aes(fill = polygon_name), alpha = 0.3) +
  scale_fill_discrete(name = "Polygons") +
  geom_sf(data = lines, aes(color = line_name)) +
  scale_color_discrete(name = "Lines") + 
  geom_sf(data = points, aes(shape = point_name), size = 3) +
  scale_shape_discrete(name = "Points")  
```


`geom_sf`来对于各种元素进行绘制。

#### `st_intersects`

这个函数能够识别`sfg`对象与`sfg`进行交互。实际上就是取交集。

```{r}
st_intersects(points, polygons)
```

```{r}
st_intersects(points, polygons, sparse = FALSE)
```


polygons and polygons

```{r}
st_intersects(polygons, polygons)
```



#### `st_is_within_distance`

```{r}
set.seed(38424738)

points_set_1 <- lapply(1:5, function(x) st_point(runif(2))) %>% 
  st_sfc() %>% st_as_sf() %>% 
  mutate(id = 1:nrow(.))

points_set_2 <- lapply(1:5, function(x) st_point(runif(2))) %>% 
  st_sfc() %>% st_as_sf() %>% 
  mutate(id = 1:nrow(.))
```




```{r}
ggplot() +
  geom_sf_text(data = points_set_1, aes(label = id), color = "red") +
  geom_sf_text(data = points_set_2, aes(label = id), color = "blue") 
```



我们可以使用`st_buffer`来构建一个buffer对象，本质上还是一个polygon对象。

```{r}
#--- create 0.2 buffers around points in points_set_1 ---#
buffer_1 <- st_buffer(points_set_1, dist = 0.2)
buffer_1
ggplot() +
  geom_sf(data = buffer_1, color = "red", fill = NA) +
  geom_sf_text(data = points_set_1, aes(label = id), color = "red") +
  geom_sf_text(data = points_set_2, aes(label = id), color = "blue") 
```


```{r}
#--- Kansas county borders ---#
KS_counties <- readRDS("Data/KS_county_borders.rds")

#--- HPA boundary ---#
hpa <- st_read(dsn = "Data", layer = "hp_bound2010") %>%
  .[1, ] %>%
  st_transform(st_crs(KS_counties))

#--- all the irrigation wells in KS ---#
KS_wells <- readRDS("Data/Kansas_wells.rds") %>%
  st_transform(st_crs(KS_counties))

#--- US railroad ---#
rail_roads <- st_read(dsn = "Data", layer = "tl_2015_us_rails") %>%
  st_transform(st_crs(KS_counties)) 
```








## raster
什么是栅格数据？在[ArcMap](https://desktop.arcgis.com/zh-cn/arcmap/latest/manage-data/raster-and-images/what-is-raster-data.htm)中的定义为

> 最简形式的栅格由按行和列（或格网）组织的像元（或像素）矩阵组成，其中的每个像元都包含一个信息值（例如温度）。栅格可以是数字航空像片、卫星影像、数字图片或甚至扫描的地图。

以栅格格式存储的数据可以表示各种实际现象：

- 专题数据（也称为离散数据）表示土地利用或土壤数据等要素。
- 连续数据表示温度、高程或光谱数据（例如，卫星影像或航空像片）等现象。
- 图片则包括扫描的地图或绘图，以及建筑物照片。


```{r}
library(raster)
```

一个最简单的栅格数据创建方法：

```{r}
x1 <- raster()
x1
```

指定维度与数据范围

```{r}
x2 <- raster(nrows = 18, ncols = 36, 
             xmn = -900, xmx = 900,
             ymn = -900, ymx = 900)
x2
```


指定数据范围与分辨率

```{r}
x3 <- raster(xmn = -900, xmx = 900,
             ymn = -900, ymx = 900,
             resolution = c(50, 100))
x3
```


指定维度与分辨率

```{r}
x4 <- raster(nrows = 18, ncols = 36, 
             resolution = c(50, 100))
x4
```


```{r}
x4$layer$values=c(36*1:18)
x4
plot(x4)
```


## 多图层栅格数据

栅格数据可以使用多层来进行叠加，`stack()`就是一个创建栅格数据合并为一个栅格数据的函数。

```{r}
r1 <- raster(ncols = 3, nrows = 3,
             vals = c(1:9))
r2 <- raster(ncols = 3, nrows = 3,
             vals = rep(c(0,1,2), 3))
r <- stack(r1, r2)
r
```

```{r}
plot(r)
```


## 代数运算
```{r}
r1 <- raster(ncols = 3, nrows = 3,
             vals = c(1:9))
r2 <- raster(ncols = 3, nrows = 3,
             vals = rep(c(0,1,2), 3))
getValues(r1)
getValues(r2)
```



## 可视化

```{r}
filename <- system.file("external/test.grd", package="raster")
r <- raster(filename)
plot(r)
```



```{r}
par(mfrow = c(2,2), plt = c(0.1,0.95,0.15,0.9))
contour(r)
persp(r)
hist(r)
density(r)

```



To be precise, here is what we mean by raster data extraction and what it does for points and polygons data:

- Points: For each of the points, find which raster cell it is located within, and assign the value of the cell to the point.

- Polygons: For each of the polygons, identify all the raster cells that intersect with the polygon, and assign a vector of the cell values to the polygon

点和多边形是栅格数据中最为重要的两个元素之一。


```{r}
library(tidycensus)
library(ggplot2)
# Identify variables for mapping
race_vars <- c(
Hispanic = "P2_002N",
White = "P2_005N",
Black = "P2_006N",
Asian = "P2_008N"
)
race_vars

```

### raster可视化

```{r}
library(rasterVis)
raster_filepath = system.file("raster/srtm.tif", package = "spDataLarge")
my_rast = rast(raster_filepath)
class(my_rast)
my_rast
ncell(my_rast)
inMemory(my_rast)
par(mar=c(2,2,2,2))
plot(my_rast)
```


```{r}
levelplot(my_rast)
```



